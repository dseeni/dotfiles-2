#!/bin/bash


fuse-umnt()
{
    command fusermount -u $@
}

cdm() {
    if [[ $1 == "-d" ]]; then
        if [ -d /mnt/drive$2 ]; then
            cd /mnt/drive$2
        else
            cd /mnt/
        fi
    elif [[ $1 == "-i" ]]; then
        if [ -d /mnt/ios$2 ]; then
            cd /mnt/ios$2
        else
            cd /mnt/
        fi
    else
        cd /mnt/
    fi
}

alias lm='ls /mnt/'


#-------------------------------------------------------------------------------
# DEVICES - except iOS
#-------------------------------------------------------------------------------

mnt()
{
    if [ $1 = "-c" -o $1 = "--custom-name" ]; then
        shift 1
        $HOME/.bash_sources/scripts/mnt_base $2 $1
    else
        i=0
        for x1 in $@
        do
            while [ true ]
            do
                x2="drive$i"
                if [ -d /mnt/$x2 ]; then
                    (( i++ ))
                else
                    break
                fi
            done
            $HOME/.bash_sources/scripts/mnt_base $x1 $x2
        done
    fi
}

umnt()
{
    cd
    if [ -e $1 ]; then
        command udisksctl unmount -b $1
    elif [ $1 = "-n" ]; then
        shift 1
        for x in $@
        do
            x="drive$x"
            $HOME/.bash_sources/scripts/umnt_base $x
        done
    else
        for x in $@
        do
            if [ ${x::5} = "drive" ]; then
                $HOME/.bash_sources/scripts/umnt_base $x
            else
                echo "No such drive"
            fi
        done
    fi

    LINKS="$(command find /mnt/ -xtype l)"

    if [ ! "$LINKS" = "" ]; then
        unlink $LINKS
        rm /mnt/.${LINKS:5}
    fi

    cd - &> /dev/null
}


#-------------------------------------------------------------------------------
# iOS DEVICES
#-------------------------------------------------------------------------------

ios-mnt()
{
    plugged=$(ideviceinstaller -l 2> /dev/null)
    if [[ $plugged == "" ]]; then
        echo "No iOS device found, is it plugged in?"
    else
        echo
        echo -e "\e[4m0 | iOS\e[0m"
        echo

        i=1
        while read app
        do
            echo $i \| $( echo $app | cut -d "," -f 3 | tr -d '"')
            appid[$i]=$( echo $app | cut -d "," -f 1 )
            (( i++ ))
        done < <(ideviceinstaller -l | sed 1d)

        echo
        echo "* Type anthing else to abort *"
        echo

        read -r -p 'Choose index of app: ' option

        j=0
        while [ true ]
        do
            x="ios$j"
            if [ -d /mnt/$x ]; then
                (( j++ ))
            else
                break
            fi
        done

        re='^[0-9]+$'
        if [[ $option == '0' ]]; then
            mkdir /mnt/$x
            ifuse /mnt/$x
        elif [[ $option =~ $re ]] ; then
            if ! [ $option -ge $i ]; then
                mkdir /mnt/$x
                ifuse --appid ${appid[$option]} /mnt/$x
            fi
        fi
    fi
}

ios-umnt()
{
    cd
    if [ -d /mnt/$1 ]; then
        fusermount -u /mnt/$1
    elif [ $1 = "-n" ]; then
        shift 1
        for x in $@
        do
            x="ios$x"
            fusermount -u /mnt/$x
        done
    fi
    rmdir /mnt/* &> /dev/null
    cd - &> /dev/null
}


#-------------------------------------------------------------------------------
# FTP
#-------------------------------------------------------------------------------

ftp-mnt()
{
    if [ $1 = "-c" ]; then
        shift 1
        mkdir /ftp/$1
        curlftpfs $2 /ftp/$1
    else
        i=0
        for x1 in $@
        do
            while [ true ]
            do
                x2="server$i"
                if [ -d /ftp/$x2 ]; then
                    (( i++ ))
                else
                    break
                fi
            done
            mkdir /ftp/$x2
            curlftpfs $1 /ftp/$x2
        done
    fi
}

ftp-umnt()
{
    cd
    if [ -d /ftp/$1 ]; then
        fusermount -u /ftp/$1
    elif [ $1 = "-n" ]; then
        shift 1
        for x in $@
        do
            x="server$x"
            fusermount -u /ftp/$x
        done
    fi
    rmdir /ftp/* &> /dev/null
    cd - &> /dev/null
}
